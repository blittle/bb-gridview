define(["backbone","underscore"],function(e,t){var n,r,i,s;return i="<table width='<%=o.options.width%>' style='height: <%=o.options.height%>' class='gvHeader' cellspacing=0 cellpadding=0> <tr><% 	if(o.options.selectionColumn) { 	%> 	<td><input type='checkbox' class='selectionColumn selectAll'/></td> 	<% 	} 	_.each(o.options.columns, function(column) {%> 	<td width='<%=o.options.width / o.options.columns.length%>'><p><%=column.label%></p></td> 	<%})%> </tr> </table> <div class='gridWrapper' style='width:<%=o.options.width%>px; height:<%=o.options.height%>px;'> 	<table width='<%=o.options.width%>'cellspacing=0 cellpadding=0 class='gvGrid'/> </div><%//@ sourceURL=GridTemplate.js%>",s="<%  if(o.options.selectionColumn) { %> 	<td><input class='selectionColumn' type='checkbox'/></td><% 	} %> <%_.each(o.options.columns, function(column) { 	var val = column.formatter ? column.formatter.call(o.model, o.model[column.key]) : o.model[column.key], 		sClassName = column.className ? column.className : '', 		editableField = column.editable ? '<input class=\"editField\" type=\"text\" value=\"' + o.model[column.key] + '\"/>' : '';%> 	<td class='<%-sClassName%>' key='<%-column.key%>' width='<%=o.options.width / o.options.columns.length%>'><p><%=val%></p><%=editableField%></td> <%});%>//@ sourceURL=RowTemplate.js%>",n=e.View.extend({tagName:"tr",className:"gvRow",initialize:function(){this.options.selection&&(this.events.click="selectRow",this.options.selectionColumn&&(this.events["click .selectionColumn"]="addToSelection")),this.render(),this.model.on("change",this.render,this)},render:function(){this.$el.html(this.options.rowTemplate({model:this.model.toJSON(),options:this.options})),this.$el.attr("id",this.model.id)},events:{"dblclick td":"startEditing","blur .editField":"saveField","change .editField":"saveField"},startEditing:function(e){var n=this.$(e.target).closest("td"),r=n.attr("key");t.find(this.options.columns,function(e){return e.key===r}).editable&&(n.find("p").hide(),n.find("input").show().focus())},saveField:function(e){var t=this.$(e.target).closest("td"),n=t.attr("key"),r={};r[n]=this.$(e.target).val(),this.model.set(r),t.find("p").show(),t.find("input").hide(),e.stopPropagation()},selectRow:function(e){this.options.selectedModels.reset(this.model)},addToSelection:function(e){this.options.selectedModels.get(this.model.id)?this.options.selectedModels.remove(this.model):this.options.selectedModels.add(this.model),e.stopPropagation()}}),r=e.View.extend({className:"gridView",initialize:function(){this.gridTemplate=t.template(i,undefined,{variable:"o"}),this.rowTemplate=t.template(s,undefined,{variable:"o"}),this.options=t.extend({autoRenderRows:!0,autoRenderNewRows:!0,autoRemoveRows:!0,width:700,height:200,logRenderTime:!1,selection:!0,selectionColumn:!1,selectedModels:new e.Collection},this.options),this.options.selectedModels.on("all",this.updateSelection,this),this.collection.on("add",this.buildRow,this),this.options.externalFilter&&this.options.externalFilter.keydown(t.bind(this.startSearch,this))},startSearch:function(e){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(t.bind(this.buildGrid,this),300)},updateSelection:function(){var e=this;this.$("tr").removeClass("selected"),this.$(".selectionColumn").prop("checked",!1),this.options.selectedModels.each(function(t,n){e.$("#"+t.id).addClass("selected").find(".selectionColumn").prop("checked",!0)})},render:function(){this.$el.html(this.gridTemplate({options:this.options})),this.buildGrid(),this.$el.attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none","-ms-user-select":"none"}).each(function(){this.onselectstart=function(){return!1}})},buildGrid:function(){var e=this.$(".gvGrid").html("").hide(),n="",r=this,i=(new Date).getTime();this.options.externalFilter&&(n=this.options.externalFilter.val()),t.each(this.findModels(n),t.bind(r.buildRow,r)),e.show(),this.options.onRender&&this.options.onRender.call(this),this.options.logRenderTime&&console.log("Render time (ms)",(new Date).getTime()-i)},findModels:function(e){var n=this,e=n.options.caseSensitive?e:(e+"").toLowerCase();return t.filter(n.collection.models,function(t){if(e==="")return!0;var r=n.options.columns,i=t.attributes,s="";for(var o in r){s=i[r[o].key]+"",s=n.options.caseSensitive?s:s.toLowerCase();if(s.indexOf(e)!==-1)return!0}return!1})},buildRow:function(e,r){var i=new n(t.extend(this.options,{model:e,rowTemplate:this.rowTemplate}));this.$(".gvGrid").append(i.el)},events:{"click .selectAll":"selectAll"},selectAll:function(e){var t=this.$(e.target).prop("checked");t?(this.$(".selectionColumn").prop("checked",!0).closest("tr").addClass("selected"),this.options.selectedModels.reset(this.collection.models,{silent:!0})):(this.$(".selectionColumn").prop("checked",!1).closest("tr").removeClass("selected"),this.options.selectedModels.reset([],{silent:!0}))}}),r});